---
import BasicLayout from '../../layouts/BasicLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';

const posts: CollectionEntry<'blog'>[] = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Liste unique des tags pour les filtres
const tags: string[] = Array.from(new Set(posts.flatMap((p) => p.data.tags ?? []))).sort((a: string, b: string) => a.localeCompare(b));
---

<BasicLayout title="Projets">
	<!-- Barre de filtres (catégories uniquement) -->
	<section class="mb-8">
		<div class="mx-auto max-w-4xl overflow-hidden rounded-xl border border-emerald-200/60 bg-white/70 supports-[backdrop-filter]:bg-white/40 backdrop-blur-md shadow-sm">
			<div class="p-4 md:p-5">
				<div class="flex items-center justify-between gap-4">
					<h2 class="text-sm font-semibold text-emerald-800 tracking-wide uppercase">Filtrer par catégories</h2>
					<p id="resultCount" class="text-xs text-emerald-800" aria-live="polite"></p>
				</div>
				{tags.length > 0 && (
					<div class="mt-4">
						<div id="tags" class="flex flex-wrap gap-2">
							<button id="tag-all" type="button" class="tag-btn rounded-full border border-emerald-300 bg-white px-3 py-1 text-xs font-medium text-emerald-700 hover:bg-emerald-50 data-[active=true]:bg-emerald-600 data-[active=true]:text-white data-[active=true]:border-emerald-600 transition" data-tag="*" data-active="true">Tous</button>
							{tags.map((t) => (
								<button type="button" class="tag-btn rounded-full border border-emerald-200/70 bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700 hover:bg-emerald-100 data-[active=true]:bg-emerald-600 data-[active=true]:text-white data-[active=true]:border-emerald-600 transition" data-tag={t}>{t}</button>
							))}
						</div>
					</div>
				)}
			</div>
		</div>
	</section>

	<section class="flex justify-center">
		<ul class="grid grid-cols-1 sm:grid-cols-2 gap-6 w-full max-w-4xl" data-posts>
			{posts.map((post) => (
				<li class="bg-white shadow-md rounded-lg overflow-hidden" data-title={post.data.title} data-desc={post.data.description} data-tags={(post.data.tags ?? []).join('|')} data-date={post.data.pubDate.toISOString()}>
					<a href={`/portfolio/blog/${post.id}/`} class="block text-gray-800 hover:text-gray-600">
						<img class="w-full h-auto" src={post.data.heroImage} alt="" />
						<div class="p-4">
							<h4 class="text-lg font-semibold mb-2">{post.data.title}</h4>
							<p class="text-sm text-gray-500 mb-2">
								<FormattedDate date={post.data.pubDate} />
							</p>
							<p class="text-gray-700 text-base">{post.data.description}</p>
							 <ul class="flex flex-wrap gap-2 mt-2">
								 {post.data.tags?.map((tag: string) => (
									<li class="bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded">
										{tag}
									</li>
								))}
							</ul>
						</div>
					</a>
				</li>
			))}
		</ul>
	</section>

	<script>
		// @ts-nocheck
		// Filtre par catégories uniquement
		const $ = (sel, root=document) => root.querySelector(sel);
		const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

		const container = document.querySelector('[data-posts]');
		const listItems = container ? Array.from(container.children) : [];
		const tagButtons = $$('#tags .tag-btn');
		const allBtn = $('#tag-all');

		const state = { tags: new Set() };

		function applyFilter() {
			let visible = 0;
			for (const li of listItems) {
				const tags = (li.dataset.tags || '').split('|').filter(Boolean);
				const okTags = state.tags.size === 0 || tags.some(t => state.tags.has(t));
				const show = okTags;
				li.classList.toggle('hidden', !show);
				if (show) visible++;
			}
			const res = $('#resultCount');
			if (res) res.textContent = visible === 0 ? 'Aucun résultat' : `${visible} projet${visible>1?'s':''}`;
		}

		function clearAll() {
			state.tags.clear();
			for (const b of tagButtons) b.dataset.active = 'false';
			if (allBtn) allBtn.dataset.active = 'true';
			applyFilter();
		}

		// Toggle des tags
		for (const btn of tagButtons) {
			if (btn.dataset.tag === '*') continue; // le bouton "Tous" a sa logique propre
			btn.addEventListener('click', () => {
				if (allBtn) allBtn.dataset.active = 'false';
				const t = btn.dataset.tag;
				const isActive = btn.dataset.active === 'true';
				if (isActive) { state.tags.delete(t); btn.dataset.active = 'false'; }
				else { state.tags.add(t); btn.dataset.active = 'true'; }
				if (state.tags.size === 0) { if (allBtn) allBtn.dataset.active = 'true'; }
				applyFilter();
			});
		}

		if (allBtn) allBtn.addEventListener('click', clearAll);

		// Init
		clearAll();
	</script>
</BasicLayout>